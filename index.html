<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dreamy Survey - ID Based Protection</title>
    <style>
        :root {
            --accent-blue: #4facfe;
            --accent-purple: #a18cd1;
            --glass-bg: rgba(255, 255, 255, 0.12);
            --text-white: #ffffff;
        }

        body, html {
            margin: 0; padding: 0;
            font-family: 'Pretendard', sans-serif;
            height: 100vh; overflow: hidden; color: var(--text-white);
            background: #0f0c29;
        }

        .bg-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-image: url('https://images.unsplash.com/photo-1534796636912-3b95b3ab5986?auto=format&fit=crop&w=1920&q=80');
            background-size: cover; background-position: center;
            z-index: -1; filter: brightness(0.8);
        }

        .main-wrapper { display: flex; justify-content: center; align-items: center; height: 100vh; width: 100vw; }

        .glass-card {
            width: 90%; max-width: 450px;
            background: var(--glass-bg); backdrop-filter: blur(25px);
            border-radius: 25px; padding: 30px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.2);
            text-align: center; position: relative;
        }

        .auth-tabs { display: flex; justify-content: center; gap: 15px; margin-bottom: 20px; }
        .tab { font-size: 1rem; font-weight: bold; cursor: pointer; color: rgba(255,255,255,0.4); }
        .tab.active { color: var(--accent-blue); border-bottom: 2px solid var(--accent-blue); }
        .auth-form input { width: 100%; box-sizing: border-box; padding: 12px; margin: 8px 0; border-radius: 10px; border: 1px solid rgba(255,255,255,0.2); background: rgba(0,0,0,0.3); color: white; outline: none; }
        
        #survey-section { display: none; }
        .menu-grid { 
            display: grid; grid-template-columns: 1fr 1fr; gap: 10px; 
            margin: 15px 0; max-height: 280px; overflow-y: auto; 
        }
        .menu-item { 
            background: rgba(255, 255, 255, 0.1); border-radius: 15px; padding: 8px; 
            cursor: pointer; border: 2px solid transparent; transition: 0.2s;
        }
        .menu-item img { width: 100%; height: 80px; object-fit: cover; border-radius: 10px; pointer-events: none; }
        .menu-item p { margin: 5px 0 0; font-size: 0.85rem; }
        .menu-item.selected { border-color: var(--accent-blue); background: rgba(79, 172, 254, 0.2); }

        .btn { width: 100%; padding: 14px; border: none; border-radius: 12px; cursor: pointer; font-weight: bold; font-size: 1rem; }
        .btn-primary { background: var(--accent-blue); color: white; margin-top: 10px; }
        .btn-loading { background: #555; cursor: wait; }

        #video-container { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 9999; }
        video { width: 100%; height: 100%; object-fit: cover; }

        .overlay-popup { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 8000; justify-content: center; align-items: center; }
        .popup-content { background: #1a1a2e; padding: 30px; border-radius: 20px; border: 1px solid var(--accent-blue); text-align: center; width: 80%; max-width: 300px; }
        .timer-line { height: 4px; background: var(--accent-blue); margin-top: 15px; width: 100%; animation: shrink 3s linear forwards; }
        @keyframes shrink { from { width: 100%; } to { width: 0%; } }
    </style>
</head>
<body>

    <div class="bg-overlay"></div>

    <div class="main-wrapper">
        <div id="auth-section" class="glass-card">
            <div class="auth-tabs">
                <span id="tab-login" class="tab active" onclick="setAuthMode('login')">ë¡œê·¸ì¸</span>
                <span id="tab-signup" class="tab" onclick="setAuthMode('signup')">íšŒì›ê°€ì…</span>
            </div>
            <div class="auth-form">
                <input type="email" id="email" placeholder="ì´ë©”ì¼">
                <input type="password" id="password" placeholder="ë¹„ë°€ë²ˆí˜¸">
                <button class="btn btn-primary" onclick="handleAuth()">ì‹œì‘í•˜ê¸°</button>
            </div>
        </div>

        <div id="survey-section" class="glass-card">
            <div style="display: flex; justify-content: space-between; font-size: 0.75rem; margin-bottom: 10px;">
                <span id="user-info"></span>
                <span onclick="logout()" style="cursor:pointer; opacity: 0.6;">ë¡œê·¸ì•„ì›ƒ</span>
            </div>
            <h3 style="margin: 0;">ğŸ´ ì €ë… ë©”ë‰´ íˆ¬í‘œ</h3>
            
            <div id="loading-spinner" style="padding: 50px 0;">ë°ì´í„°ë¥¼ í™•ì¸ ì¤‘ì…ë‹ˆë‹¤...</div>
            
            <div id="voting-content" style="display:none;">
                <div class="menu-grid" id="menu-list"></div>
                <button class="btn btn-primary" id="submit-btn" onclick="submitVote()">íˆ¬í‘œ ì œì¶œí•˜ê¸°</button>
            </div>

            <div id="already-voted" style="display:none; padding: 40px 0;">
                <h1 style="font-size: 3rem; margin: 0;">âœ…</h1>
                <p>ì´ë¯¸ ì•„ì´ë”” ê¸°ì¤€ìœ¼ë¡œ íˆ¬í‘œë¥¼ ì™„ë£Œí•˜ì…¨ìŠµë‹ˆë‹¤!<br>ì¤‘ë³µ ì°¸ì—¬ëŠ” ë¶ˆê°€ëŠ¥í•©ë‹ˆë‹¤.</p>
            </div>
        </div>
    </div>

    <div id="video-container">
        <video id="dance-video" playsinline muted>
            <source src="https://www.w3schools.com/html/mov_bbb.mp4" type="video/mp4">
        </video>
    </div>

    <div id="popup" class="overlay-popup">
        <div class="popup-content">
            <h2 style="color:var(--accent-blue); margin-top:0;">ğŸ‰ ì €ì¥ ì™„ë£Œ!</h2>
            <p>ID ê¸°ì¤€ìœ¼ë¡œ íˆ¬í‘œê°€ ê¸°ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.<br>3ì´ˆ ë’¤ ì˜ìƒì´ ì‹œì‘ë©ë‹ˆë‹¤.</p>
            <div class="timer-line"></div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";
        // getDocì„ ì¶”ê°€í•˜ì—¬ ê¸°ì¡´ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤.
        import { getFirestore, doc, setDoc, getDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBQ6nSIQqbNLXuZNiqFBgewi4cGusTykfI",
            authDomain: "site1-b1f47.firebaseapp.com",
            projectId: "site1-b1f47",
            storageBucket: "site1-b1f47.firebasestorage.app",
            messagingSenderId: "269436929092",
            appId: "1:269436929092:web:c603f6895c2b6567cde811"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let selectedMenus = [];
        let userId = "";

        const menus = [
            { id: 1, name: "ì¹˜í‚¨", img: "chicken" }, { id: 2, name: "ì´ˆë°¥", img: "sushi" },
            { id: 3, name: "í”¼ì", img: "pizza" }, { id: 4, name: "íŒŒìŠ¤íƒ€", img: "pasta" },
            { id: 5, name: "ìŠ¤í…Œì´í¬", img: "steak" }, { id: 6, name: "ë–¡ë³¶ì´", img: "spicy" },
            { id: 7, name: "í–„ë²„ê±°", img: "burger" }, { id: 8, name: "ë¼ë©´", img: "ramen" },
            { id: 9, name: "ë¹„ë¹”ë°¥", img: "rice" }, { id: 10, name: "íƒ€ì½”", img: "taco" }
        ];

        // [í•µì‹¬ ë¡œì§] ë¡œê·¸ì¸ ìƒíƒœ í™•ì¸ ì‹œ Firestoreì—ì„œ íˆ¬í‘œ ê¸°ë¡ ì¡°íšŒ
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                userId = user.uid; // ì‚¬ìš©ìì˜ ê³ ìœ  ì•„ì´ë””
                document.getElementById('auth-section').style.display = 'none';
                document.getElementById('survey-section').style.display = 'block';
                document.getElementById('user-info').innerText = user.email;

                // ğŸ” ë°ì´í„°ë² ì´ìŠ¤ì—ì„œ ì´ ìœ ì €ì˜ IDê°€ ìˆëŠ”ì§€ í™•ì¸
                const docRef = doc(db, "votes", userId);
                const docSnap = await getDoc(docRef);

                document.getElementById('loading-spinner').style.display = 'none';

                if (docSnap.exists()) {
                    // ê¸°ë¡ì´ ìˆìœ¼ë©´: ì´ë¯¸ íˆ¬í‘œí•¨ UI ë³´ì—¬ì¤Œ
                    document.getElementById('voting-content').style.display = 'none';
                    document.getElementById('already-voted').style.display = 'block';
                } else {
                    // ê¸°ë¡ì´ ì—†ìœ¼ë©´: ì„¤ë¬¸ UI ë³´ì—¬ì¤Œ
                    document.getElementById('voting-content').style.display = 'block';
                    document.getElementById('already-voted').style.display = 'none';
                    renderMenus();
                }
            } else {
                document.getElementById('auth-section').style.display = 'block';
                document.getElementById('survey-section').style.display = 'none';
            }
        });

        function renderMenus() {
            const list = document.getElementById('menu-list');
            list.innerHTML = '';
            menus.forEach(m => {
                const div = document.createElement('div');
                div.className = 'menu-item';
                div.innerHTML = `<img src="https://loremflickr.com/200/150/${m.img},food"><p>${m.name}</p>`;
                div.onclick = () => {
                    const idx = selectedMenus.indexOf(m.name);
                    if (idx > -1) { selectedMenus.splice(idx, 1); div.classList.remove('selected'); }
                    else if (selectedMenus.length < 3) { selectedMenus.push(m.name); div.classList.add('selected'); }
                };
                list.appendChild(div);
            });
        }

        window.submitVote = async () => {
            if (selectedMenus.length === 0) return alert("ë©”ë‰´ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.");
            
            const btn = document.getElementById('submit-btn');
            btn.innerText = "ì €ì¥ ì¤‘...";
            btn.classList.add('btn-loading');

            try {
                // ì•„ì´ë””(userId)ë¥¼ ë¬¸ì„œ ì´ë¦„ìœ¼ë¡œ ì‚¬ìš©í•˜ì—¬ Firestoreì— ì €ì¥
                await setDoc(doc(db, "votes", userId), {
                    email: auth.currentUser.email,
                    selections: selectedMenus,
                    votedAt: serverTimestamp()
                });

                document.getElementById('popup').style.display = 'flex';
                
                setTimeout(() => {
                    document.getElementById('popup').style.display = 'none';
                    document.getElementById('survey-section').parentElement.style.display = 'none';
                    const video = document.getElementById('dance-video');
                    document.getElementById('video-container').style.display = 'block';
                    video.play();
                }, 3000);

            } catch (err) {
                alert("ì €ì¥ ì˜¤ë¥˜: " + err.message);
                btn.innerText = "íˆ¬í‘œ ì œì¶œí•˜ê¸°";
                btn.classList.remove('btn-loading');
            }
        };

        window.setAuthMode = (mode) => {
            document.getElementById('tab-login').classList.toggle('active', mode === 'login');
            document.getElementById('tab-signup').classList.toggle('active', mode === 'signup');
        };

        window.handleAuth = async () => {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            try {
                if (document.getElementById('tab-signup').classList.contains('active')) {
                    await createUserWithEmailAndPassword(auth, email, password);
                } else {
                    await signInWithEmailAndPassword(auth, email, password);
                }
            } catch (e) { alert(e.message); }
        };

        window.logout = () => signOut(auth);
    </script>
</body>
</html>
