<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dreamy Survey Final - Fixed</title>
    <style>
        :root {
            --accent-blue: #4facfe;
            --accent-purple: #a18cd1;
            --glass-bg: rgba(255, 255, 255, 0.12);
            --text-white: #ffffff;
        }

        body, html {
            margin: 0; padding: 0;
            font-family: 'Pretendard', sans-serif;
            height: 100vh; overflow: hidden; color: var(--text-white);
            background: #0f0c29;
        }

        /* ğŸŒŒ ëª½í™˜ì ì¸ ë³´ë¼ìƒ‰ ë°°ê²½ */
        .bg-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-image: url('https://images.unsplash.com/photo-1534796636912-3b95b3ab5986?auto=format&fit=crop&w=1920&q=80');
            background-size: cover; background-position: center;
            z-index: -1; filter: brightness(0.8);
        }

        .main-wrapper {
            display: flex; justify-content: center; align-items: center;
            height: 100vh; width: 100vw;
        }

        .glass-card {
            width: 90%; max-width: 450px;
            background: var(--glass-bg); backdrop-filter: blur(20px);
            border-radius: 25px; padding: 30px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.2);
            text-align: center; position: relative;
        }

        /* --- Auth UI --- */
        .auth-tabs { display: flex; justify-content: center; gap: 15px; margin-bottom: 20px; }
        .tab { font-size: 1rem; font-weight: bold; cursor: pointer; color: rgba(255,255,255,0.4); transition: 0.3s; }
        .tab.active { color: var(--accent-blue); border-bottom: 2px solid var(--accent-blue); }
        .auth-form input { width: 100%; box-sizing: border-box; padding: 12px; margin: 8px 0; border-radius: 10px; border: 1px solid rgba(255,255,255,0.2); background: rgba(0,0,0,0.3); color: white; outline: none; }
        
        /* --- Survey UI --- */
        #survey-section { display: none; }
        .menu-grid { 
            display: grid; grid-template-columns: 1fr 1fr; gap: 10px; 
            margin: 15px 0; max-height: 280px; overflow-y: auto; padding-right: 5px;
        }
        .menu-item { 
            background: rgba(255, 255, 255, 0.1); border-radius: 15px; padding: 8px; 
            cursor: pointer; border: 2px solid transparent; transition: 0.2s;
        }
        .menu-item img { width: 100%; height: 80px; object-fit: cover; border-radius: 10px; pointer-events: none; }
        .menu-item p { margin: 5px 0 0; font-size: 0.85rem; }
        .menu-item.selected { border-color: var(--accent-blue); background: rgba(79, 172, 254, 0.2); }

        .btn { width: 100%; padding: 14px; border: none; border-radius: 12px; cursor: pointer; font-weight: bold; font-size: 1rem; transition: 0.3s; }
        .btn-primary { background: var(--accent-blue); color: white; margin-top: 10px; }
        .btn-primary:hover { filter: brightness(1.1); transform: translateY(-1px); }

        /* --- ğŸ¬ Full Screen Video --- */
        #video-container {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; z-index: 9999;
        }
        video { width: 100%; height: 100%; object-fit: cover; }

        /* --- íŒì—… ì•Œë¦¼ --- */
        .overlay-popup {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); z-index: 8000; justify-content: center; align-items: center;
        }
        .popup-content { background: #1a1a2e; padding: 30px; border-radius: 20px; border: 1px solid var(--accent-blue); text-align: center; width: 80%; max-width: 300px; }
        .timer-line { height: 4px; background: var(--accent-blue); margin-top: 15px; width: 100%; animation: shrink 3s linear forwards; }
        @keyframes shrink { from { width: 100%; } to { width: 0%; } }

        /* ìŠ¤í¬ë¡¤ë°” ë””ìì¸ */
        .menu-grid::-webkit-scrollbar { width: 4px; }
        .menu-grid::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 10px; }
    </style>
</head>
<body>

    <div class="bg-overlay"></div>

    <div class="main-wrapper">
        <div id="auth-section" class="glass-card">
            <div class="auth-tabs">
                <span id="tab-login" class="tab active" onclick="setAuthMode('login')">ë¡œê·¸ì¸</span>
                <span id="tab-signup" class="tab" onclick="setAuthMode('signup')">íšŒì›ê°€ì…</span>
            </div>
            <div class="auth-form">
                <input type="email" id="email" placeholder="ì´ë©”ì¼">
                <input type="password" id="password" placeholder="ë¹„ë°€ë²ˆí˜¸(6ì ì´ìƒ)">
                <button class="btn btn-primary" onclick="handleAuth()">ì‹œì‘í•˜ê¸°</button>
            </div>
        </div>

        <div id="survey-section" class="glass-card">
            <div style="display: flex; justify-content: space-between; font-size: 0.75rem; margin-bottom: 10px;">
                <span id="user-info"></span>
                <div>
                    <span onclick="resetVoteRecord()" style="cursor:pointer; color:#ffeb3b; margin-right:10px;">[ê¸°ë¡ë¦¬ì…‹]</span>
                    <span onclick="logout()" style="cursor:pointer;">ë¡œê·¸ì•„ì›ƒ</span>
                </div>
            </div>
            <h3 style="margin: 0;">ğŸ´ ì €ë… ë©”ë‰´ íˆ¬í‘œ</h3>
            <p style="font-size: 0.8rem; opacity: 0.7; margin: 5px 0;">ì˜¤ëŠ˜ì˜ ì¶”ì²œ ë©”ë‰´ (ìµœëŒ€ 3ê°œ)</p>
            
            <div class="menu-grid" id="menu-list"></div>
            
            <button class="btn btn-primary" id="submit-btn-element" onclick="submitVote()">íˆ¬í‘œ ì œì¶œí•˜ê¸°</button>
            <div id="voted-msg" style="display:none; padding: 20px; color: var(--accent-purple); font-weight: bold;">
                ì´ë¯¸ ì°¸ì—¬í•˜ì…¨ìŠµë‹ˆë‹¤! âœ…
            </div>
        </div>
    </div>

    <div id="video-container">
        <video id="dance-video" playsinline muted>
            <source src="https://www.w3schools.com/html/mov_bbb.mp4" type="video/mp4">
        </video>
    </div>

    <div id="popup" class="overlay-popup">
        <div class="popup-content">
            <h2 style="color:var(--accent-blue); margin-top:0;">ğŸ‰ ì™„ë£Œ!</h2>
            <p>ì°¸ì—¬ ê°ì‚¬ë“œë¦½ë‹ˆë‹¤.<br>3ì´ˆ ë’¤ ì¶•í•˜ ì˜ìƒ ì‹œì‘!</p>
            <div class="timer-line"></div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } 
        from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBQ6nSIQqbNLXuZNiqFBgewi4cGusTykfI",
            authDomain: "site1-b1f47.firebaseapp.com",
            projectId: "site1-b1f47",
            storageBucket: "site1-b1f47.firebasestorage.app",
            messagingSenderId: "269436929092",
            appId: "1:269436929092:web:c603f6895c2b6567cde811"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);

        let currentMode = 'login';
        let selectedMenus = [];
        let userId = "";

        const menus = [
            { id: 1, name: "ì¹˜í‚¨", img: "chicken" }, { id: 2, name: "ì´ˆë°¥", img: "sushi" },
            { id: 3, name: "í”¼ì", img: "pizza" }, { id: 4, name: "íŒŒìŠ¤íƒ€", img: "pasta" },
            { id: 5, name: "ìŠ¤í…Œì´í¬", img: "steak" }, { id: 6, name: "ë–¡ë³¶ì´", img: "spicy" },
            { id: 7, name: "í–„ë²„ê±°", img: "burger" }, { id: 8, name: "ë¼ë©´", img: "ramen" },
            { id: 9, name: "ë¹„ë¹”ë°¥", img: "rice" }, { id: 10, name: "íƒ€ì½”", img: "taco" }
        ];

        // 1. ìƒíƒœ ê°ì§€
        onAuthStateChanged(auth, (user) => {
            if (user) {
                userId = user.uid;
                document.getElementById('auth-section').style.display = 'none';
                document.getElementById('survey-section').style.display = 'block';
                document.getElementById('user-info').innerText = user.email.split('@')[0] + "ë‹˜";
                
                checkVoteStatus();
            } else {
                document.getElementById('auth-section').style.display = 'block';
                document.getElementById('survey-section').style.display = 'none';
            }
        });

        // 2. íˆ¬í‘œ ì—¬ë¶€ ì²´í¬
        function checkVoteStatus() {
            const hasVoted = localStorage.getItem('voted_' + userId);
            const btn = document.getElementById('submit-btn-element');
            const msg = document.getElementById('voted-msg');
            const list = document.getElementById('menu-list');

            if (hasVoted) {
                btn.style.display = 'none';
                msg.style.display = 'block';
                list.innerHTML = `<div style="grid-column: 1/3; padding: 40px 0; opacity: 0.5;">íˆ¬í‘œê°€ ì™„ë£Œëœ ì„¤ë¬¸ì…ë‹ˆë‹¤.</div>`;
            } else {
                btn.style.display = 'block';
                msg.style.display = 'none';
                renderMenus();
            }
        }

        // 3. ë©”ë‰´ ê·¸ë¦¬ê¸°
        function renderMenus() {
            const list = document.getElementById('menu-list');
            list.innerHTML = '';
            selectedMenus = [];
            menus.forEach(m => {
                const div = document.createElement('div');
                div.className = 'menu-item';
                div.innerHTML = `<img src="https://loremflickr.com/200/150/${m.img},food"><p>${m.name}</p>`;
                div.onclick = () => {
                    const idx = selectedMenus.indexOf(m.id);
                    if (idx > -1) {
                        selectedMenus.splice(idx, 1);
                        div.classList.remove('selected');
                    } else if (selectedMenus.length < 3) {
                        selectedMenus.push(m.id);
                        div.classList.add('selected');
                    } else {
                        alert("ìµœëŒ€ 3ê°œê¹Œì§€ë§Œ ì„ íƒ ê°€ëŠ¥í•©ë‹ˆë‹¤!");
                    }
                };
                list.appendChild(div);
            });
        }

        // 4. íˆ¬í‘œ ì œì¶œ
        window.submitVote = () => {
            if (selectedMenus.length === 0) {
                alert("ìµœì†Œ 1ê°œì˜ ë©”ë‰´ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.");
                return;
            }

            localStorage.setItem('voted_' + userId, 'true');
            document.getElementById('popup').style.display = 'flex';

            setTimeout(() => {
                document.getElementById('popup').style.display = 'none';
                document.getElementById('survey-section').parentElement.style.display = 'none';
                const videoCont = document.getElementById('video-container');
                const video = document.getElementById('dance-video');
                
                videoCont.style.display = 'block';
                video.play().catch(() => {
                    video.muted = true;
                    video.play();
                });

                video.onended = () => location.reload();
            }, 3000);
        };

        // 5. ê¸°íƒ€ ê¸°ëŠ¥ (ë¡œê·¸ì¸, ë¦¬ì…‹ ë“±)
        window.setAuthMode = (mode) => {
            currentMode = mode;
            document.getElementById('tab-login').classList.toggle('active', mode === 'login');
            document.getElementById('tab-signup').classList.toggle('active', mode === 'signup');
        };

        window.handleAuth = async () => {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            if (password.length < 6) { alert("ë¹„ë°€ë²ˆí˜¸ 6ì ì´ìƒ!"); return; }
            try {
                if (currentMode === 'signup') {
                    await createUserWithEmailAndPassword(auth, email, password);
                    alert("ê°€ì… ì™„ë£Œ!");
                } else {
                    await signInWithEmailAndPassword(auth, email, password);
                }
            } catch (e) { alert("ì˜¤ë¥˜: " + e.message); }
        };

        window.logout = () => { if(confirm("ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) signOut(auth); };

        // [ì¤‘ìš”] í…ŒìŠ¤íŠ¸ë¥¼ ìœ„í•´ íˆ¬í‘œ ê¸°ë¡ì„ ì§€ìš°ëŠ” í•¨ìˆ˜
        window.resetVoteRecord = () => {
            localStorage.removeItem('voted_' + userId);
            alert("íˆ¬í‘œ ê¸°ë¡ì´ ë¦¬ì…‹ë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ í…ŒìŠ¤íŠ¸í•´ë³´ì„¸ìš”!");
            checkVoteStatus();
        };
    </script>
</body>
</html>